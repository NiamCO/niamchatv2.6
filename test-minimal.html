<!DOCTYPE html>
<html>
<head>
    <title>NiamChat Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>NiamChat Debug Test</h1>
    
    <div class="section">
        <h2>1. Test Supabase Connection</h2>
        <button onclick="testConnection()">Test Connection</button>
        <div id="connectionResult"></div>
    </div>
    
    <div class="section">
        <h2>2. Create Test User</h2>
        <input type="text" id="testUsername" placeholder="Enter username" value="TestUser">
        <button onclick="createTestUser()">Create User</button>
        <div id="createUserResult"></div>
    </div>
    
    <div class="section">
        <h2>3. Send Test Message</h2>
        <button onclick="sendTestMessage()">Send Test Message</button>
        <div id="sendMessageResult"></div>
    </div>
    
    <div class="section">
        <h2>4. Check Database</h2>
        <button onclick="checkDatabase()">Check Tables</button>
        <div id="databaseResult"></div>
    </div>
    
    <div class="section">
        <h2>Console Output:</h2>
        <pre id="consoleOutput"></pre>
    </div>

    <script>
        // Clear any existing supabase variable
        if (window.supabase) {
            console.log('Clearing existing supabase reference');
            window.supabase = null;
        }
        
        // Create fresh Supabase client
        const SUPABASE_URL = 'https://tayhblmwkaujtkuulfqj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRheWhibG13a2F1anRrdXVsZnFqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNDQxNDEsImV4cCI6MjA4NTkyMDE0MX0.CY3cjbUqeVUynIHrsZ62fHCxFK-FtPxjxPOYwYL7a4E'; // âš ï¸ REPLACE THIS
        
        let debugSupabase;
        
        function log(message) {
            console.log(message);
            const output = document.getElementById('consoleOutput');
            output.textContent += message + '\n';
        }
        
        async function testConnection() {
            log('ðŸ” Testing Supabase connection...');
            log('URL: ' + SUPABASE_URL);
            log('Key length: ' + (SUPABASE_ANON_KEY ? SUPABASE_ANON_KEY.length : 'NOT SET'));
            
            try {
                // Check if Supabase JS is loaded
                if (typeof window.supabase === 'undefined') {
                    log('âŒ Supabase JS not loaded. Loading now...');
                    await loadSupabaseJS();
                }
                
                // Create new client
                debugSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('âœ… Supabase client created');
                
                // Test simple query
                const { data, error } = await debugSupabase.from('users').select('count').limit(1);
                
                if (error) {
                    log('âŒ Query error: ' + error.message);
                    log('Code: ' + error.code);
                    log('Details: ' + JSON.stringify(error));
                    
                    if (error.code === '42P01') {
                        log('âš ï¸ Table "users" does not exist. Creating tables...');
                        await createTables();
                    }
                } else {
                    log('âœ… Connection successful!');
                    log('Response: ' + JSON.stringify(data));
                }
                
            } catch (err) {
                log('âŒ Connection failed: ' + err.message);
                log('Stack: ' + err.stack);
            }
        }
        
        async function loadSupabaseJS() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@supabase/supabase-js@2';
                script.onload = () => {
                    log('âœ… Supabase JS loaded');
                    resolve();
                };
                script.onerror = () => {
                    log('âŒ Failed to load Supabase JS');
                    reject();
                };
                document.head.appendChild(script);
            });
        }
        
        async function createTables() {
            log('ðŸ“ Creating database tables...');
            
            // We'll need to run SQL in Supabase dashboard
            log('Please run this SQL in Supabase SQL Editor:');
            log(`
                -- 1. Create users table
                CREATE TABLE IF NOT EXISTS users (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    username TEXT UNIQUE NOT NULL,
                    role TEXT DEFAULT 'user',
                    is_online BOOLEAN DEFAULT false,
                    current_room TEXT DEFAULT 'open',
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- 2. Create messages table  
                CREATE TABLE IF NOT EXISTS messages (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    room TEXT NOT NULL,
                    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
                    username TEXT NOT NULL,
                    content TEXT NOT NULL,
                    is_deleted BOOLEAN DEFAULT false,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );
                
                -- 3. Disable RLS for testing
                ALTER TABLE users DISABLE ROW LEVEL SECURITY;
                ALTER TABLE messages DISABLE ROW LEVEL SECURITY;
                
                -- 4. Insert test users
                INSERT INTO users (username, role, is_online) 
                VALUES 
                    ('Doneman123', 'owner', true),
                    ('TestAdmin', 'admin', true),
                    ('TestUser', 'user', true)
                ON CONFLICT (username) DO NOTHING;
            `);
        }
        
        async function createTestUser() {
            const username = document.getElementById('testUsername').value || 'TestUser';
            log('ðŸ‘¤ Creating user: ' + username);
            
            try {
                if (!debugSupabase) {
                    log('âŒ Supabase client not initialized');
                    return;
                }
                
                const { data, error } = await debugSupabase
                    .from('users')
                    .insert({
                        username: username,
                        role: 'user',
                        is_online: true
                    })
                    .select();
                
                if (error) {
                    log('âŒ Error creating user: ' + error.message);
                } else {
                    log('âœ… User created: ' + JSON.stringify(data));
                }
                
            } catch (err) {
                log('âŒ Error: ' + err.message);
            }
        }
        
        async function sendTestMessage() {
            log('ðŸ’¬ Sending test message...');
            
            try {
                if (!debugSupabase) {
                    log('âŒ Supabase client not initialized');
                    return;
                }
                
                // First get or create a user
                const { data: users } = await debugSupabase
                    .from('users')
                    .select('id, username')
                    .limit(1);
                
                if (!users || users.length === 0) {
                    log('âŒ No users found. Create a user first.');
                    return;
                }
                
                const user = users[0];
                
                // Send message
                const { data, error } = await debugSupabase
                    .from('messages')
                    .insert({
                        room: 'open',
                        user_id: user.id,
                        username: user.username,
                        content: 'Test message from debug tool'
                    })
                    .select();
                
                if (error) {
                    log('âŒ Error sending message: ' + error.message);
                } else {
                    log('âœ… Message sent: ' + JSON.stringify(data));
                }
                
            } catch (err) {
                log('âŒ Error: ' + err.message);
            }
        }
        
        async function checkDatabase() {
            log('ðŸ—„ï¸ Checking database...');
            
            try {
                if (!debugSupabase) {
                    log('âŒ Supabase client not initialized');
                    return;
                }
                
                // Check users table
                const { data: users, error: usersError } = await debugSupabase
                    .from('users')
                    .select('*')
                    .limit(5);
                
                if (usersError) {
                    log('âŒ Users table error: ' + usersError.message);
                } else {
                    log('ðŸ‘¥ Users (' + (users?.length || 0) + '):');
                    users?.forEach(u => log('  - ' + u.username + ' (' + u.role + ')'));
                }
                
                // Check messages table
                const { data: messages, error: messagesError } = await debugSupabase
                    .from('messages')
                    .select('*')
                    .limit(5);
                
                if (messagesError) {
                    log('âŒ Messages table error: ' + messagesError.message);
                } else {
                    log('ðŸ’¬ Messages (' + (messages?.length || 0) + '):');
                    messages?.forEach(m => log('  - ' + m.username + ': ' + m.content));
                }
                
            } catch (err) {
                log('âŒ Error checking database: ' + err.message);
            }
        }
        
        // Initialize
        log('ðŸš€ NiamChat Debug Tool Started');
        log('=============================');
        log('1. First, get your ANON_KEY from Supabase:');
        log('   - Go to Supabase Dashboard');
        log('   - Settings > API');
        log('   - Copy "anon public" key');
        log('2. Replace line 24 in this file with your key');
        log('3. Click "Test Connection"');
        log('=============================');
    </script>
</body>
</html>
